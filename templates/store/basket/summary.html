{% extends 'store/base.html' %}

{% block title %}Store Basket{% endblock %}

{% block content %}

  <h1>Basket</h1>
  <main class="container pt-5">
    {#  <div class="col-12 text-end">#}
    {#    <div class="h6 fw-bold">Sub Total: $<span id="subtotal1">{{ basket.get_total_price }}</span></div>#}
    {#  </div>#}
    {% for item in basket %}
      {% with product=item.product %}
        <div class="row border mb-4 p-3" id="product-{{ product.id }}">
          <div class="col-md-3 col-lg-2 order-md-first bg-light">
            <a href="{{ product.get_absolute_url }}">
              <img src="{{ product.image.url }}" alt="Product image" class="img-fluid mx-auto d-block"
                   style="width: 120px">
            </a>
          </div>
          <div class="col-md-9 ">
            <div class="h5 p-2"><a class="text-decoration-none text-dark"
                                   href="{{ product.get_absolute_url }}">{{ product.title }}</a></div>
            <div class="border">
              <div class="col border-bottom">
                <div class="row p-3">
                  <div class="col ">
                    <span class="text-secondary">Price: </span>{{ product.price }}
                  </div>
                  <div class="col text-end">
                    <span class="text-secondary">Total price: </span>$<span id="product-total-{{ product.id }}">{{ item.total_price }}</span>
                  </div>
                </div>
                <div class="col">
                  <div class="row p-3">
                    <div class="col-6 my-auto">
                      <label for="select">Quantity: </label>
                      <select name="select" id="select-{{ product.id }}">
                        <option selected value="{{ item.quantity }}">{{ item.quantity }}</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                      </select>
                    </div>
                    <div class="col-6 text-end">
                      <button type="button" id="update-button" value="{{ product.id }}" class="btn btn-primary">
                        Update
                      </button>
                      <button type="button" id="delete-button" value="{{ product.id }}" class="btn btn-danger">
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>


        </div>
      {% endwith %}
    {% endfor %}
    <div class="col-12 text-end">
      <div class="h6 fw-bold">Sub Total: $<span id="basket-total">{{ basket.get_total_price }}</span></div>
    </div>

  </main>
    <script>
    //delete
      $(document).on('click', '#delete-button', (e) => {
          e.preventDefault()
          const productId = e.target.value
          $.ajax({
              type: 'POST',
              url: '{% url "basket:basket_delete" %}',
              data: {
                  productId: productId,
                  csrfmiddlewaretoken: "{{ csrf_token }}",
                  action: 'post'
              },
              success: (json) => {
                  console.log(json)
                  $('#basket-qty').text(json.basket_qty)
                  $('#basket-total').text(json.basket_price)
                  $(`#product-${productId}`).remove()
              },
              error: (xhr, errmsg, err) => {

              }
          });

      });

      // update
    $(document).on('click', '#update-button', (e) => {
          e.preventDefault()
          const productId = e.target.value
          $.ajax({
              type: 'POST',
              url: '{% url "basket:basket_update" %}',
              data: {
                  productId: productId,
                  productQty: $(`#select-${productId}`).val(),
                  csrfmiddlewaretoken: "{{ csrf_token }}",
                  action: 'post'
              },
              success: (json) => {
                  console.log(json)
                  $('#basket-qty').text(json.basket_qty)
                  $('#basket-total').text(json.basket_price)
                  $(`#product-total-${productId}`).text(json.product_total)
              },
              error: (xhr, errmsg, err) => {
                console.log(err)
              }
          });

      });
  </script>

{% endblock %}